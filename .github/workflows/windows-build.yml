name: windows-build

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    env:
      WINDOWS_PFX_BASE64: ${{ secrets.WINDOWS_PFX_BASE64 }}
      WINDOWS_PFX_PASSWORD: ${{ secrets.WINDOWS_PFX_PASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore CrossfireCrosshair.csproj

      - name: Build
        run: dotnet build CrossfireCrosshair.csproj -c Release --no-restore

      - name: Publish single-file exe
        run: >
          dotnet publish CrossfireCrosshair.csproj
          -c Release
          -r win-x64
          --self-contained true
          -p:PublishSingleFile=true
          -p:IncludeNativeLibrariesForSelfExtract=true
          -p:PublishTrimmed=false
          -p:DebugType=None
          -o artifacts/win-x64

      - name: Optional code signing
        if: ${{ env.WINDOWS_PFX_BASE64 != '' && env.WINDOWS_PFX_PASSWORD != '' }}
        shell: pwsh
        run: |
          $pfxPath = Join-Path $env:RUNNER_TEMP "codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:WINDOWS_PFX_BASE64))
          $signTool = (Get-Command signtool.exe -ErrorAction Stop).Source
          $exe = Get-ChildItem artifacts/win-x64 -Filter *.exe | Select-Object -First 1
          if (-not $exe) { throw "No executable found to sign." }
          & $signTool sign /f $pfxPath /p $env:WINDOWS_PFX_PASSWORD /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 $exe.FullName

      - name: Compute package metadata
        id: meta
        shell: pwsh
        run: |
          if ("${{ github.ref_type }}" -eq "tag") {
            $version = "${{ github.ref_name }}"
          } else {
            $version = "ci-${{ github.run_number }}"
          }
          "version=$version" >> $env:GITHUB_OUTPUT

      - name: Package and checksum
        id: package
        shell: pwsh
        env:
          VERSION: ${{ steps.meta.outputs.version }}
        run: |
          $zipName = "CrossfireCrosshair-$env:VERSION-win-x64.zip"
          $shaName = "CrossfireCrosshair-$env:VERSION-win-x64.sha256"
          Compress-Archive -Path artifacts/win-x64/* -DestinationPath "artifacts/$zipName" -Force
          $hash = (Get-FileHash "artifacts/$zipName" -Algorithm SHA256).Hash.ToLowerInvariant()
          "$hash  $zipName" | Out-File "artifacts/$shaName" -Encoding ascii
          "zip_name=$zipName" >> $env:GITHUB_OUTPUT
          "sha_name=$shaName" >> $env:GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: CrossfireCrosshair-${{ steps.meta.outputs.version }}-win-x64
          path: |
            artifacts/${{ steps.package.outputs.zip_name }}
            artifacts/${{ steps.package.outputs.sha_name }}

      - name: Create GitHub release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/${{ steps.package.outputs.zip_name }}
            artifacts/${{ steps.package.outputs.sha_name }}
